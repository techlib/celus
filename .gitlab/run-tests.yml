tests:run_tests:
  stage: tests
  needs: []
  image: registry.gitlab.com/big-dig-data/celus/celus-test:latest
  services:
    - postgres
    - redis
  variables:
    DJANGO_SETTINGS_MODULE: config.settings.test
    POSTGRES_DB: celus
    POSTGRES_USER: celus
    POSTGRES_PASSWORD: celus
    POSTGRES_HOST: postgres
    REDIS_URL: "redis://redis:6379/1"
    DEBIAN_FRONTEND: noninteractive
  before_script:
    - apt-get update -qy
    - apt-get install -y gnupg
    - apt-key adv --keyserver keyserver.ubuntu.com --recv E0C56BD4
    - echo "deb http://repo.yandex.ru/clickhouse/deb/stable/ main/" > /etc/apt/sources.list.d/clickhouse.list
    - apt-get update -qy
    - apt-get install -y curl clickhouse-server
    - service clickhouse-server start
    - poetry install
  script:
    - cat .env.example | sed "s/\(CLICKHOUSE_.*_ACTIVE\)=.*$/\\1=True/g" > .env
    - poetry run pytest -v -n 2 --create-db --junitxml=report.xml --cov=activity --cov=annotations --cov=api --cov=charts --cov=core --cov=cost --cov=erms --cov=logs --cov=nigiri --cov=organizations --cov=publications --cov=sushi --cov=recache --cov=knowledgebase --cov-report=xml --cov-report=term apps/
  artifacts:
    reports:
      junit: report.xml
      cobertura: coverage.xml
  coverage: /^TOTAL.*\s+([^\s]+)%$/
  tags:
    - bdd

tests:load_initial_data:
  stage: tests
  needs: []
  image: registry.gitlab.com/big-dig-data/celus/celus-test:latest
  services:
    - postgres
    - redis
  variables:
    DJANGO_SETTINGS_MODULE: config.settings.test
    POSTGRES_DB: celus_loaddata
    POSTGRES_USER: celus_loaddata
    POSTGRES_PASSWORD: celus_loaddata
    POSTGRES_HOST: postgres
    REDIS_URL: "redis://redis:6379/1"
  before_script:
    - poetry install
  script:
    - cp .env.example .env
    - poetry run python manage.py migrate
    - poetry run python manage.py loaddata data/initial-data.json
  tags:
    - bdd
